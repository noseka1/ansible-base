apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: autogitops-dir
  namespace: {{ autogitops_argocd_namespace }}
spec:
  goTemplate: true
  generators:
  - git:
      files:
      - path: apps/**/argocd_config_dir.yaml
      repoURL: {{ gitea_repo_url_plain }}
      revision: ag-{{ openshift_common_cluster_domain }}
      template:
        metadata: {}
        spec:
          destination: {}
          project: ""
          source:
            repoURL: {{ gitea_repo_url_plain }}
  syncPolicy:
    preserveResourcesOnDeletion: true
  template:
    metadata:
      labels:
{% raw %}
        app.kubernetes.io/name: '{{ .path.basename }}'
      name: '{{ .path.basename }}'
{% endraw %}
      namespace: {{ autogitops_argocd_namespace }}
    spec:
      destination:
        name: {{ openshift_common_cluster_domain }}
{% raw %}
        namespace: '{{ .destNamespace }}'
{% endraw %}
      info:
      - name: creator
        value: 'AutoGitOps - Ansible-driven Argo CD automation'
      project: {{ openshift_common_cluster_domain | regex_replace('\.', '-') }}
      source:
{% raw %}
        path: '{{ .sourcePath }}'
{% endraw %}
        repoURL: ""
        targetRevision: ag-{{ openshift_common_cluster_domain }}
        directory:
          recurse: true
      syncPolicy:
        syncOptions:
        - ApplyOutOfSyncOnly=true
        - FailOnSharedResource=true
        - ServerSideApply=true
        - PrunePropagationPolicy=background
