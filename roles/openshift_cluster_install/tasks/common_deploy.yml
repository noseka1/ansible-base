- name: Check the install_complete timestamp
  stat:
    path: '{{ osclusterinstall_info.config_dir }}/install_complete'
    get_checksum: false
    get_mime: false
  register: osclusterinstall_complete

- debug:
    msg: >-
      Found cluster installation timestamp in directory {{ osclusterinstall_info.config_dir }}, assuming that the
      cluster already exists, skipping the installation. If you are trying to reinstall the cluster, delete the cluster
      using an Ansible playbook before running this playbook.

  when:
    - osclusterinstall_complete.stat.exists

- name: Set target OpenShift version
  set_fact:
    osclusterinstall_version_resolved: '{{ osclusterinstall_info.version }}'
  when:
    - osclusterinstall_info.version != 'latest'
    - not osclusterinstall_complete.stat.exists

- import_tasks: cluster_version.yml
  when:
    - osclusterinstall_info.version == 'latest'
    - not osclusterinstall_complete.stat.exists

- import_tasks: cluster_installer.yml
  when:
    - not osclusterinstall_complete.stat.exists

- import_tasks: cluster_install.yml
  when:
    - not osclusterinstall_complete.stat.exists

- name: Create the timestamp
  file:
    path: '{{ osclusterinstall_info.config_dir }}/install_complete'
    state: touch
    mode: '0644'
  when:
    - not osclusterinstall_complete.stat.exists

- import_tasks: report_success.yml

- import_role:
    name: openshift_cluster_postinstall
    tasks_from: deploy.yml
  environment:
    K8S_AUTH_KUBECONFIG: '{{ osclusterinstall_info.config_dir }}/auth/kubeconfig'
    KUBECONFIG: '{{ osclusterinstall_info.config_dir }}/auth/kubeconfig'
  when: osclusterinstall_run_postinstall
