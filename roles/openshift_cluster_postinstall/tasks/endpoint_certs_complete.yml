- name: Create certificate resources
  kubernetes.core.k8s:
    template: endpoint-certs/certificate.yaml
  loop:
    - cert_name: api-cert
      cert_namespace: openshift-config
      cert_common_name: 'api.{{ oscommon_cluster_domain }}'
    - cert_name: wildcard-cert
      cert_namespace: openshift-ingress
      cert_common_name: '*.{{ oscommon_default_ingresscontroller.spec.domain }}'

- name: Waiting since {{ lookup("pipe", "date +%r") }} for certificates to become ready
  kubernetes.core.k8s_info:
    api_version: cert-manager.io/v1
    kind: Certificate
    namespace: '{{ item.cert_namespace }}'
    name: '{{ item.cert_name }}'
  loop:
    - cert_name: api-cert
      cert_namespace: openshift-config
    - cert_name: wildcard-cert
      cert_namespace: openshift-ingress
  register: osclusterpostinst_endpoint_certs_result
  until:
    - osclusterpostinst_endpoint_certs_result.resources.0.status.conditions is defined
    - osclusterpostinst_endpoint_certs_result.resources.0.status.conditions | selectattr('type', 'equalto', 'Ready') | list | length > 0
    - (osclusterpostinst_endpoint_certs_result.resources.0.status.conditions | selectattr('type', 'equalto', 'Ready') | first).status == "True"
  retries: 48
  delay: 5

- name: Configure certificate for Kubernetes API
  kubernetes.core.k8s:
    template: endpoint-certs/cluster-apiserver.yaml
  register: osclusterpostinst_endpoint_certs_apply_apiserver_result
  when:
    - oscommon_infrastructure.status.controlPlaneTopology not in ['External']

- name: Configure certificate for default OpenShift ingress router
  kubernetes.core.k8s:
    template: endpoint-certs/default-ingresscontroller.yaml
  register: osclusterpostinst_endpoint_certs_apply_ingresscontroller_result

- import_tasks: kubeconfig_remove_ca.yml
  when:
    - osclusterpostinst_configure_kubeconfig
    - osclusterpostinst_endpoint_certs_apply_apiserver_result is changed

- import_role:
    name: openshift_common
    tasks_from: wait_for_stable_cluster.yml
  vars:
    stable_cluster_delay: 120
    stable_cluster_retries: 10
  when: >-
    osclusterpostinst_endpoint_certs_apply_apiserver_result is changed or
    osclusterpostinst_endpoint_certs_apply_ingresscontroller_result is changed
