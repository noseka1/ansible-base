- name: Retrieve current kubeconfig
  command: >-
    oc config view
  changed_when: false
  register: osclusterpostinst_kubeconfig_result

- set_fact:
    osclusterpostinst_kubeconfig_yaml: '{{ osclusterpostinst_kubeconfig_result.stdout | from_yaml }}'

- set_fact:
    osclusterpostinst_kubeconfig_curr_context: '{{ osclusterpostinst_kubeconfig_yaml["current-context"] }}'

- set_fact:
    osclusterpostinst_kubeconfig_curr_cluster: >-
      {{ (osclusterpostinst_kubeconfig_yaml.contexts | selectattr('name', 'equalto', osclusterpostinst_kubeconfig_curr_context) | first).context.cluster }}

- set_fact:
    osclusterpostinst_kubeconfig_curr_cert: >-
      {{ (osclusterpostinst_kubeconfig_yaml.clusters | selectattr('name', 'equalto', osclusterpostinst_kubeconfig_curr_cluster) | first).cluster["certificate-authority-data"] | default('') }}

- name: Remove certificate-authority-data from cluster {{ osclusterpostinst_kubeconfig_curr_cluster }} kubeconfig file
  command: |-
    oc config set-cluster {{ osclusterpostinst_kubeconfig_curr_cluster }} \
      --certificate-authority=/dev/null \
      --embed-certs=true
  when:
    osclusterpostinst_kubeconfig_curr_cert | length > 0

- name: Set insecure-skip-tls-verify for cluster {{ osclusterpostinst_kubeconfig_curr_cluster }} kubeconfig file
  command: |-
    oc config set-cluster {{ osclusterpostinst_kubeconfig_curr_cluster }} \
      --insecure-skip-tls-verify=true
  when:
    osclusterpostinst_kubeconfig_curr_cert | length > 0
