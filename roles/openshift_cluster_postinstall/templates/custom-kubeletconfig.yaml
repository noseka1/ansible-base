apiVersion: machineconfiguration.openshift.io/v1
kind: KubeletConfig
metadata:
  name: custom
spec:
  # Match all cluster nodes
  machineConfigPoolSelector:
    matchLabels:
      machineconfiguration.openshift.io/mco-built-in: ""
  # Automatically determine the optimal system-reserved CPU and memory resources
  # $ee also https://docs.openshift.com/container-platform/latest/nodes/nodes/nodes-nodes-resources-configuring.html
  # This should prevent Prometheus alerts like SystemMemoryExceedsReservation
  autoSizingReserved: true
  kubeletConfig:
    # Registry image pull Queries Per Second. Set to no limit to avoid pull QPS exceeded on cluster reboot.
    # See also:
    # Why pod fails to start with the message " ErrImagePull: "pull QPS exceeded"" in OpenShift Container Platform ?
    # https://access.redhat.com/solutions/4767061
    registryPullQPS: 0
    # Two parameters control the maximum number of pods that can be scheduled to a node: podsPerCore and maxPods.
    # If you use both options, the lower of the two limits the number of pods on a node.
    #
    # See also https://docs.redhat.com/en/documentation/openshift_container_platform/4.19/html/nodes/working-with-nodes#nodes-nodes-managing-max-pods
    #
    # The maxPods parameter sets the number of pods the node can run to a fixed value, regardless of the properties of the node.
    # Set maxPods field to increase the maximum number of pods that can be placed on a single node. The default maximum is 250.
    # When using large cluster nodes, this default maximum can be easily exceeded.
    maxPods: 500
    # The podsPerCore parameter sets the number of pods the node can run based on the number of processor cores on the node.
    # For example, if podsPerCore is set to 10 on a node with 4 processor cores, the maximum number of pods allowed on the
    # node will be 40.
    # Setting podsPerCore to 0 (which is the default) disables this limit:
    podsPerCore: 0
    # The rate at which the Kubelet talks to the Kubernetes API server depends on queries per second (QPS) and burst values. The default values
    # are 50 for kubeAPIQPS and 100 for kubeAPIBurst. Increasing the default kubeAPIBurst and kubeAPIQPS values can improve pod startup times in
    # clusters with large nodes.
    #
    # On a VM-based clusters the default values 50 and 100 are recommended as we don’t want to overload the Kubernetes API server. On bare metal
    # clusters, the control plane has enough hardware resources to accommodate the additional load on the Kubernetes API server.
    #
    # References:
    # * OpenShift Virtualization - Tuning & Scaling Guide
    #   https://access.redhat.com/articles/6994974
    # * Let’s Speed up Kubernetes Again!
    #   https://medium.com/@muthanagavamsi/lets-speed-up-kubernetes-again-666fa5de541c
{% if oscommon_infrastructure.status.platformStatus.type == 'BareMetal' %}
    kubeAPIQPS: 100
    kubeAPIBurst: 200
{% endif %}
