# To test the alert routing, you can generate a test alert.
#
# Jump into the alertmanager pod:
#
# oc rsh -n openshift-monitoring alertmanager-main-0
#
# Execute the following command that creates a test alert:
#
# amtool alert add \
#   --alertmanager.url http://localhost:9093 \
#   --start "$(date -Iseconds)" \
#   --end "$(date -Iseconds -d 'now +1 minutes')" \
#   --annotation 'summary="Test summary"' \
#   --annotation 'description="Test description"' \
#   "alert-$(date +%s)" \
#   severity=warning
#
apiVersion: v1
kind: Secret
metadata:
  name: alertmanager-main
  namespace: openshift-monitoring
stringData:
  alertmanager.yaml: |
    route:
      # Don't group alerts by any label
      group_by: ['...']
      # Set the repeat inverval to match the retention interval. This maximizes the time before
      # alert notification is resent. The alert notification will be resent once per retention
      # interval which is set in Alertmanager.spec.retention field to 120h (i.e. 5 days).
      # Unfortunately, it looks like it is not possible to change the retention interval in the
      # Alertmanager that is managed by the OpenShift cluster monitoring operator.
      repeat_interval: 120h
      # Root route must specify a default receiver
      receiver: default
      routes:
{% if openshift_send_alerts_to_slack.enabled %}
      - receiver: slack_channel
        # Don't stop, carry on to the next rule
        continue: true
{% endif %}
{% if openshift_send_alerts_to_email.enabled %}
      - matchers:
        - severity =~ "warning|critical"
        receiver: email_important
      - # Receiver with no matcher matches everything
        receiver: email_other
{% endif %}
    receivers:
    - name: default
{% if openshift_send_alerts_to_slack.enabled %}
    - name: slack_channel
      slack_configs:
      - api_url: '{{ openshift_send_alerts_to_slack_url }}'
        send_resolved: true
        text: |
{% raw %}
          Severity: {{ .CommonLabels.severity }}
          Message: {{ .CommonAnnotations.SortedPairs.Values | join " " }}
{% endraw %}
{% endif %}
{% if openshift_send_alerts_to_email.enabled %}
    - name: email_important
      email_configs:
      - to: receiver@example.com
        from: important@example.com
        smarthost: '{{ openshift_send_alerts_to_email.smarthost }}'
        require_tls: {{ openshift_send_alerts_to_email.require_tls }}
    - name: email_other
      email_configs:
      - to: receiver@example.com
        from: other@example.com
        smarthost: '{{ openshift_send_alerts_to_email.smarthost }}'
        require_tls: {{ openshift_send_alerts_to_email.require_tls }}
{% endif %}
