- assert:
    that: efs_aws_access_key_id | length > 0
    fail_msg: Variable 'efs_aws_access_key_id' must not be empty
    quiet: true

- assert:
    that: efs_aws_secret_access_key | length > 0
    fail_msg: Variable 'efs_aws_secret_access_key' must not be empty
    quiet: true

- import_role:
    name: openshift_common
    tasks_from: get_infrastructure.yml

- name: Set cluster ID and AWS region
  set_fact:
    efs_cluster_id: '{{ oscommon_infrastructure.status.infrastructureName }}'
    efs_aws_region: '{{ oscommon_infrastructure.status.platformStatus.aws.region }}'

- name: Retrieve OpenShift cluster VPC
  amazon.aws.ec2_vpc_net_info:
    filters:
      'tag:Name': '{{ efs_cluster_id }}-vpc'
    aws_access_key_id: '{{ efs_aws_access_key_id }}'
    aws_secret_access_key: '{{ efs_aws_secret_access_key }}'
  register: efs_vpc_result

- name: Delete EFS
  community.aws.efs:
    name: myefs
    region: '{{ efs_aws_region }}'
    state: absent
    aws_access_key_id: '{{ efs_aws_access_key_id }}'
    aws_secret_access_key: '{{ efs_aws_secret_access_key }}'

- name: Delete security group
  amazon.aws.ec2_security_group:
    name: myefs
    vpc_id: '{{ efs_vpc_result.vpcs.0.vpc_id }}'
    region: '{{ efs_aws_region }}'
    state: absent
    aws_access_key_id: '{{ efs_aws_access_key_id }}'
    aws_secret_access_key: '{{ efs_aws_secret_access_key }}'
