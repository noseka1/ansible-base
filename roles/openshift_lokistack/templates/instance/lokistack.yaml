apiVersion: loki.grafana.com/v1
kind: LokiStack
metadata:
  name: loki
  namespace: {{ loki_instance_namespace }}
spec:
  limits:
    global:
      # Tuning Loki parameters as per:
      # https://docs.openshift.com/container-platform/4.17/observability/network_observability/installing-operators.html#network-observability-lokistack-configuring-ingestionnetwork_observability
      ingestion:
        # IngestionBurstSize defines the rate-limited sample size per distributor replica.
        # It should be set to at least to the maximum logs size expected in a single push request.
        ingestionBurstSize: 40
        # IngestionRate defines the sample size per second. Units MB.
        ingestionRate: 20
        # MaxGlobalStreamsPerTenant defines the maximum number of active streams per tenant, across the cluster.
        maxGlobalStreamsPerTenant: 25000
      queries:
        # MaxChunksPerQuery defines the maximum number of chunks that can be fetched by a single query
        maxChunksPerQuery: 2000000
        # MaxEntriesLimitsPerQuery defines the maximum number of log entries that will be returned for a query.
        maxEntriesLimitPerQuery: 10000
        # MaxQuerySeries defines the maximum of unique series that is returned by a metric query.
        maxQuerySeries: 3000
      # You can set retention rules globally, per-tenant, or both. If you configure both, tenant rules have precedence over global rules.
      #
      # Important: If there is no retention period defined on the S3 bucket or in the LokiStack custom resource (CR), then the logs are not pruned
      # and they stay in the S3 bucket forever, which might fill up the s3 storage.
      #
      # For cost-effective log pruning, configure retention policies directly on the S3 bucket. Use the lifecycle management features of the S3 bucket
      # to ensure automatic deletion of old logs. This also avoids extra processing from Loki and delete requests to S3.
      #
      # If the object storage does not support lifecycle policies, you must configure LokiStack to enforce retention internally. The supported
      # retention period is up to 30 days.
      #
      # See also https://docs.redhat.com/en/documentation/red_hat_openshift_logging/6.4/html/configuring_logging/configuring-lokistack-storage#logging-loki-retention_configuring-the-log-store
      retention:
        days: 30
    tenants:
      application:
        retention:
          days: 30
      audit:
        retention:
          days: 30
      infrastructure:
        retention:
          days: 30
  # Available sizes are 1x.demo, 1x.pico, 1x.extra-small, 1x.small, 1x.medium
  # For production systems, use 1x.small or 1x.medium
  # Link: https://docs.redhat.com/en/documentation/red_hat_openshift_logging/6.4/html-single/configuring_logging/index#loki-sizing_configuring-the-log-store
  size: 1x.extra-small
  storage:
    schemas:
    - version: v12
      effectiveDate: 2022-06-01
    secret:
      name: loki-s3
      type: s3
    # Optionally, configure trusted CA certificate for the S3 endpoint.
    #tls:
      # caName is the name of a ConfigMap containing the CA certificate.
      # Note that this is a refence to a ConfigMap and not a Secret object!
      #caName: loki-s3
      #caKey: ca.crt
  storageClassName: {{ openshift_common_default_storage_class }}
  tenants:
    mode: {{ loki_instance_tenants_mode }}
{% if loki_place_on_infra_nodes %}
  template:
    compactor:
      nodeSelector:
        node-role.kubernetes.io/infra: ""
      tolerations:
      - effect: NoSchedule
        key: node-role.kubernetes.io/infra
    distributor:
      nodeSelector:
        node-role.kubernetes.io/infra: ""
      tolerations:
      - effect: NoSchedule
        key: node-role.kubernetes.io/infra
    indexGateway:
      nodeSelector:
        node-role.kubernetes.io/infra: ""
      tolerations:
      - effect: NoSchedule
        key: node-role.kubernetes.io/infra
    ingester:
      nodeSelector:
        node-role.kubernetes.io/infra: ""
      tolerations:
      - effect: NoSchedule
        key: node-role.kubernetes.io/infra
    querier:
      nodeSelector:
        node-role.kubernetes.io/infra: ""
      tolerations:
      - effect: NoSchedule
        key: node-role.kubernetes.io/infra
    queryFrontend:
      nodeSelector:
        node-role.kubernetes.io/infra: ""
      tolerations:
      - effect: NoSchedule
        key: node-role.kubernetes.io/infra
    ruler:
      nodeSelector:
        node-role.kubernetes.io/infra: ""
      tolerations:
      - effect: NoSchedule
        key: node-role.kubernetes.io/infra
    gateway:
      nodeSelector:
        node-role.kubernetes.io/infra: ""
      tolerations:
      - effect: NoSchedule
        key: node-role.kubernetes.io/infra
{% endif %}
