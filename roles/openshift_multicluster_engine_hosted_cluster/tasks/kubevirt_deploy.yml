- name: Enable wildcard DNS routes
  kubernetes.core.k8s:
    template:
      - kubevirt/prereqs/default-ingresscontroller.yaml

- name: Create namespace for hosted cluster configuration
  kubernetes.core.k8s:
    template:
      - kubevirt/prereqs/hosted-clusters-ns.yaml

- name: Fix kubevirt-csi controller deployment
  kubernetes.core.k8s:
    template:
      - kubevirt/fix/namespace.yaml
      - kubevirt/fix/role.yaml
      - kubevirt/fix/rolebinding.yaml

- import_role:
    name: openshift_autogitops
    tasks_from: app_deploy.yml
  vars:
    autogitops_app_src_path: templates/kubevirt/instance
    autogitops_app_dst_path: hosted-cluster/kubevirt
    autogitops_app_namespace: hosted-clusters
    autogitops_app_sync_retries: 600

- import_tasks: kubevirt_success.yml
