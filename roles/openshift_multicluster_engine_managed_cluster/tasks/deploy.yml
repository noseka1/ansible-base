- name: Retrieve all CRDs
  kubernetes.core.k8s_info:
    api_version: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
  register: multicluster_engine_managed_cluster_crd_result

- set_fact:
    rhacm_detected: >-
      {{ multicluster_engine_managed_cluster_crd_result.resources
          | json_query("[?spec.group=='agent.open-cluster-management.io' && spec.names.kind=='KlusterletAddonConfig']") | length == 1 }}

- name: Create ClusterImageSet for OCP version {{ multicluster_engine_managed_cluster.ocp_release_image }}
  kubernetes.core.k8s:
    template:
      - clusterimageset/clusterimageset.yaml

- import_tasks: cloud_deploy.yml
  when: multicluster_engine_managed_cluster_platform in [ 'AWS', 'AZURE' ]

- import_tasks: baremetal_deploy.yml
  when: multicluster_engine_managed_cluster_platform in [ 'BareMetal' ]

- import_tasks: report_success.yml
