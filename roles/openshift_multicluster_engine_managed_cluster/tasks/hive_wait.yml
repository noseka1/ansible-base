- name: Retrieve cluster provisioning reference
  kubernetes.core.k8s_info:
    api_version: hive.openshift.io/v1
    kind: ClusterDeployment
    name: '{{ mcemanagedcluster_info.cluster_name }}'
    namespace: '{{ mcemanagedcluster_info.cluster_name }}'
  register: mcemanagedcluster_clusterdeployment_result
  until:
    - (mcemanagedcluster_clusterdeployment_result.resources.0.status.provisionRef.name is defined)
      or
      ((mcemanagedcluster_clusterdeployment_result.resources.0.status.conditions is defined) and
      (mcemanagedcluster_clusterdeployment_result.resources.0.status.conditions | selectattr('type', 'equalto', 'ProvisionFailed') | list | length > 0) and
      (mcemanagedcluster_clusterdeployment_result.resources.0.status.conditions | selectattr('type', 'equalto', 'ProvisionFailed') | first).status == "True")
  retries: 12
  delay: 5

- fail:
    msg: Cluster provisioning failed.
  when: >-
    ((mcemanagedcluster_clusterdeployment_result.resources.0.status.conditions is defined) and
    (mcemanagedcluster_clusterdeployment_result.resources.0.status.conditions | selectattr('type', 'equalto', 'ProvisionFailed') | list | length > 0) and
    (mcemanagedcluster_clusterdeployment_result.resources.0.status.conditions | selectattr('type', 'equalto', 'ProvisionFailed') | first).status == "True")

- name: Retrieve provisioning job reference
  kubernetes.core.k8s_info:
    api_version: hive.openshift.io/v1
    kind: ClusterProvision
    name: '{{ mcemanagedcluster_clusterdeployment_result.resources.0.status.provisionRef.name }}'
    namespace: '{{ mcemanagedcluster_info.cluster_name }}'
  register: mcemanagedcluster_clusterprovision_result
  until:
    - mcemanagedcluster_clusterprovision_result.resources.0.status.jobRef.name is defined
  retries: 12
  delay: 5

- debug:
    msg: >-
      oc logs -n {{ mcemanagedcluster_info.cluster_name }} job/{{ mcemanagedcluster_clusterprovision_result.resources.0.status.jobRef.name }} -c installer -f

- name: Waiting since {{ lookup("pipe", "date +%r") }} for provisioning job {{ mcemanagedcluster_clusterprovision_result.resources.0.status.jobRef.name }} to complete
  kubernetes.core.k8s_info:
    api_version: batch/v1
    kind: Job
    name: '{{ mcemanagedcluster_clusterprovision_result.resources.0.status.jobRef.name }}'
    namespace: '{{ mcemanagedcluster_info.cluster_name }}'
  register: mcemanagedcluster_provisioning_job_result
  until:
    - mcemanagedcluster_provisioning_job_result.resources.0.status.conditions is defined
    - ((mcemanagedcluster_provisioning_job_result.resources.0.status.conditions | selectattr('type', 'equalto', 'Failed') | list | length > 0) and
      (mcemanagedcluster_provisioning_job_result.resources.0.status.conditions | selectattr('type', 'equalto', 'Failed') | first).status == "True")
      or
      ((mcemanagedcluster_provisioning_job_result.resources.0.status.conditions | selectattr('type', 'equalto', 'Complete') | list | length > 0) and
      (mcemanagedcluster_provisioning_job_result.resources.0.status.conditions | selectattr('type', 'equalto', 'Complete') | first).status == "True")
  retries: 300
  delay: 20

- fail:
    msg: Cluster provisioning failed.
  when: >-
    ((mcemanagedcluster_provisioning_job_result.resources.0.status.conditions | selectattr('type', 'equalto', 'Failed') | list | length > 0) and
    (mcemanagedcluster_provisioning_job_result.resources.0.status.conditions | selectattr('type', 'equalto', 'Failed') | first).status == "True")
