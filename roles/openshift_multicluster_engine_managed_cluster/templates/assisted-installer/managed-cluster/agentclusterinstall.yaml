apiVersion: extensions.hive.openshift.io/v1beta1
kind: AgentClusterInstall
metadata:
  annotations:
    agent-install.openshift.io/install-config-overrides: '{{ lookup("template", "assisted-installer/install-config/install-config.yaml") | from_yaml | to_json }}'
  name: {{ mcemanagedcluster_info.cluster_name }}
  namespace: {{ mcemanagedcluster_info.cluster_name }}
spec:
{% if not mcemanagedcluster_info.user_managed_networking %}
  apiVIP: {{ mcemanagedcluster_info.api_vip }}
  ingressVIP: {{ mcemanagedcluster_info.ingress_vip }}
{% endif %}
  clusterDeploymentRef:
    name: {{ mcemanagedcluster_info.cluster_name }}
  provisionRequirements:
    controlPlaneAgents: {{ mcemanagedcluster_control_plane_agents | int }}
{% if mcemanagedcluster_worker_agents | int > 0 %}
    workerAgents: {{ mcemanagedcluster_worker_agents | int }}
{% endif %}
  # By default, SMT (or hyperthreading) is enabled to increase the performance of your machines' cores.
  # Therefore, you can omit this section unless you wish to disable hyperthreading.
  # You can disable SMT by setting the parameter value to 'Disabled'. Then, you must disable it in all cluster machines;
  # this includes both control plane and compute machines.
  controlPlane:
    hyperthreading: Enabled
    name: master
  compute:
  - hyperthreading: Enabled
    name: worker
  imageSetRef:
    name: img{{ mcemanagedcluster_info.ocp_release_image | regex_replace('_', '-',) }}-appsub
  networking:
    clusterNetwork:
    - cidr: 10.128.0.0/14
      hostPrefix: 23
    serviceNetwork:
    - 172.30.0.0/16
    userManagedNetworking: {{ mcemanagedcluster_info.user_managed_networking }}
{% if mcemanagedcluster_info.clusterwide_proxy %}
  proxy:
    httpProxy: {{ mcemanagedcluster_info.clusterwide_proxy.http_proxy }}
    httpsProxy: {{ mcemanagedcluster_info.clusterwide_proxy.https_proxy }}
    noProxy: {{ mcemanagedcluster_info.clusterwide_proxy.no_proxy }}
{% endif %}
{% if mcemanagedcluster_info.ssh_authorized_key | length > 0 %}
  sshPublicKey: '{{ mcemanagedcluster_info.ssh_authorized_key }}'
{% endif %}
