- name: Create prerequisites for csi-driver-nfs
  kubernetes.core.k8s:
    template:
      - csi/namespace.yaml
      - csi/rolebinding.yaml

- name: Add csi-driver-nfs chart repo
  kubernetes.core.helm_repository:
    name: csi-driver-nfs
    repo_url: https://raw.githubusercontent.com/kubernetes-csi/csi-driver-nfs/master/charts

- name: Deploy csi-driver-nfs Helm chart
  kubernetes.core.helm:
    name: '{{ csinfs_name }}'
    chart_ref: csi-driver-nfs/csi-driver-nfs
    chart_version: '{{ csinfs_version  }}'
    release_namespace: '{{ csinfs_namespace }}'
    release_values: '{{ lookup("template", "csi/values.yaml") | from_yaml }}'
    skip_crds: true
    wait: true

- name: Obtain nfs-server service
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Service
    name: nfs-server
    namespace: '{{ nfsserver_namespace }}'
  register: nfsserver_service

- name: Check if default storage class exists
  import_role:
    name: openshift_common
    tasks_from: get_default_storage_class.yml

- name: Create nfs-csi storageclass
  kubernetes.core.k8s:
    template:
      - csi/storageclass.yaml
