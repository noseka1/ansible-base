# Enable Link Layer Discovery Protocol (LLDP) on all Ethernet interfaces. See also:
# Example: Node network configuration policy to enable LLDP reporting
# https://docs.redhat.com/en/documentation/openshift_container_platform/4.19/html/networking/kubernetes-nmstate#virt-example-enabling-lldp-policy_k8s-nmstate-updating-node-network-config
#
# Once LLDP is enabled, the NetworkManager will listen on LLDP packages, there is no need to run other LLDP agent daemon like lldpad.
# Link: https://nmstate.io/features/lldp.html
#
# Verify that LLDP is enabled for the specific interfaces:
# $ nmcli --fields connection.lldp con show ovs-if-phys0
# connection.lldp:                        enable-rx
#
# Display information about neighboring devices learned through the Link Layer Discovery Protocol (LLDP). This
# can be used to find out which switch port (port-id) is the specific network interface connected to:
#
# The information is included in the nodenetworkstate resource for the specific node:
#
# $ oc get nodenetworkstate -o yaml <node>
#
# ...

# lldp:
#    enabled: true
#    neighbors:
#    - - type: 5
#        system-name: switchXYZ.example.com
#      - type: 6
#        system-description: Arista Networks EOS version 4.28.10.1M running on an Arista Networks DCS-7050SX-64
#      - type: 7
#        system-capabilities:
#        - MAC Bridge component
#        - Router
#      - type: 1
#        chassis-id: 2C:DD:E9:CD:A1:01
#        chassis-id-type: 4
#        _description: MAC address
#      - type: 2
#        port-id: Ethernet47
#        port-id-type: 5
#        _description: Interface name
#      - type: 8
#        management-addresses:
#        - address: 10.100.0.19
#          address-subtype: IPv4
#          interface-number: 2001501
#          interface-number-subtype: 2
#      - type: 127
#        ieee-802-3-max-frame-size: 9416
#        oui: 00:12:0f
#        subtype: 4#
#
# Directly on the node, the nmcli can be used to list the neighboring devices:
#
# $ nmcli dev lldp
#
# Note that only LLDP receive (RX) is supported at this time. LLDP transmit (TX) is not supported:
#
# LLDP tx support on baremetal
# https://issues.redhat.com/browse/RFE-4209
#
# Note that the following configuration may fail to apply due to conflicts with other NNCP configurations
# applied to the same node:
#
apiVersion: nmstate.io/v1
kind: NodeNetworkConfigurationPolicy
metadata:
  name: enable-lldp-ethernets-up
spec:
  capture:
    ethernets: interfaces.type=="ethernet"
    ethernets-up: capture.ethernets | interfaces.state=="up"
    ethernets-lldp: capture.ethernets-up | interfaces.lldp.enabled:=true
  desiredState:
    interfaces: "{{ capture.ethernets-lldp.interfaces }}"
