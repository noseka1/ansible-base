- import_role:
    name: openshift_common
    tasks_from: get_infrastructure.yml

- import_role:
    name: openshift_hashicorp_vault
    tasks_from: secret_insert.yml
  vars:
    hvault_mount_point: autogitops
    hvault_secret_name: '{{ oscommon_cluster_domain }}/rhacs/central/central-db-password'
    hvault_secret_data:
      password: '{{ generic_user_password }}'

- import_role:
    name: openshift_hashicorp_vault
    tasks_from: secret_insert.yml
  vars:
    hvault_mount_point: autogitops
    hvault_secret_name: '{{ oscommon_cluster_domain }}/rhacs/central/central-htpasswd'
    hvault_secret_data:
      password: '{{ generic_user_password }}'
      htpasswd: admin:{{ generic_user_password | string | password_hash("bcrypt", "constant1234567890123.") }}

- import_role:
    name: openshift_hashicorp_vault
    tasks_from: secret_insert.yml
  vars:
    hvault_mount_point: autogitops
    hvault_secret_name: '{{ oscommon_cluster_domain }}/rhacs/central/scanner-db-password'
    hvault_secret_data:
      password: '{{ generic_user_password }}'

- import_role:
    name: openshift_hashicorp_vault
    tasks_from: secret_insert.yml
  vars:
    hvault_mount_point: autogitops
    hvault_secret_name: '{{ oscommon_cluster_domain }}/rhacs/central/central-default-tls-cert'
    hvault_secret_data:
      tls.crt: '{{ rhacs_central_default_tls_cert[oscommon_cluster_domain].crt }}'
      tls.key: '{{ rhacs_central_default_tls_cert[oscommon_cluster_domain].key }}'
  when: rhacs_central_default_tls_cert[oscommon_cluster_domain] is defined

- import_role:
    name: openshift_autogitops
    tasks_from: app_deploy.yml
  vars:
    autogitops_app_src_path: templates/central
    autogitops_app_dst_path: rhacs/central
    autogitops_app_namespace: stackrox

- name: Obtain Central TLS secret
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Secret
    name: central-tls
    namespace: stackrox
  register: rhacs_central_tls
  until: rhacs_central_tls.resources | length == 1
  retries: 12
  delay: 10

- name: Create a reencrypt route
  kubernetes.core.k8s:
    template: route/central-reencrypt-route.yaml
