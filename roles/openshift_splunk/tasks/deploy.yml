- import_role:
    name: openshift_common
    tasks_from: install_plan_approve
  vars:
    oscomm_subscription_name: splunk
    oscomm_subscription_namespace: openshift-operators

- import_role:
    name: openshift_autogitops
    tasks_from: app_deploy.yml
  vars:
    autogitops_app_src_path: templates/operator
    autogitops_app_dst_path: splunk/operator
    autogitops_app_namespace: openshift-operators

- import_role:
    name: openshift_hashicorp_vault
    tasks_from: secret_insert.yml
  vars:
    hvault_mount_point: autogitops
    hvault_secret_name: '{{ openshift_common_cluster_domain }}/splunk/instance/credentials'
    hvault_secret_data:
      #hec_token: CEEC6F85-10D4-41FD-B7BA-86026102C3B5
      #idxc_secret: AA8CUQWAwEaESgV7WSGAt6o3
      #pass4SymmKey: FVgKfq0rSXyJdNNI8VN65YvB
      password: '{{ generic_user_password }}'
      #shc_secret: YcBshr1jNyYZXrVj87I5898a

- import_role:
    name: openshift_autogitops
    tasks_from: app_deploy.yml
  vars:
    autogitops_app_src_path: templates/instance
    autogitops_app_dst_path: splunk/instance
    autogitops_app_namespace: '{{ splunk_instance_namespace }}'

- import_tasks: get_hec_connection.yml

- name: Waiting since {{ lookup("pipe", "date +%r") }} for Splunk to come up
  uri:
    url: '{{ splunk_hec_json_endpoint }}'
    method: POST
    headers:
      Authorization: Splunk {{ splunk_hec_token }}
    body_format: json
    body:
      event: Hello from Ansible at {{ lookup("pipe", "date +%r") }}
    validate_certs: false
    status_code: [ 200, 503 ]
  register: splunk_uri_result
  until: splunk_uri_result.status == 200
  retries: 12
  delay: 10

- import_tasks: report_success.yml
