- name: Check if preferred storageclasses exists in the cluster
  kubernetes.core.k8s_info:
    api_version: storage.k8s.io/v1
    kind: StorageClass
    name: '{{ item }}'
  register: osvirt_ocs_storageclasses_result
  loop:
    # Storageclasses in the order of preference
    - ocs-storagecluster-ceph-rbd-virtualization
    - ocs-external-storagecluster-ceph-rbd
    - rook-ceph-block-virtualization
    - nfs-csi
    - efs-csi

- name: Pick the most preferred storageclass
  set_fact:
    osvirt_ocs_storageclasses_defs: >-
      {{ osvirt_ocs_storageclasses_result.results | json_query("[].resources[0]") }}

- set_fact:
    osvirt_machine_eviction_strategy: LiveMigrate
    osvirt_machine_root_disk_access_modes: [ 'ReadWriteMany' ]
    osvirt_machine_root_disk_storage_class_name: '{{ osvirt_ocs_storageclasses_defs.0.metadata.name }}'
    osvirt_machine_root_disk_volume_mode: >-
      {{ "Filesystem" if osvirt_ocs_storageclasses_defs.0.metadata.name in ["nfs-csi", "efs-csi"] else "Block" }}
  when: osvirt_ocs_storageclasses_defs | length > 0

- import_role:
    name: openshift_hashicorp_vault
    tasks_from: secret_insert.yml
  vars:
    hvault_mount_point: autogitops
    hvault_secret_name: '{{ oscommon_cluster_domain }}/openshift-virtualization/example-workload/cloud-init'
    hvault_secret_data:
      userdata: |
        #cloud-config
        user: admin
        password: '{{ generic_user_password }}'
        chpasswd:
          expire: false
        ssh_pwauth: true
        ssh_authorized_keys:
        - '{{ osvirt_machine_ssh_authorized_key }}'

- import_role:
    name: openshift_autogitops
    tasks_from: app_deploy.yml
  vars:
    autogitops_app_src_path: templates/example-workload
    autogitops_app_dst_path: openshift-virtualization/example-workload
    autogitops_app_namespace: '{{ osvirt_machine_namespace }}'
