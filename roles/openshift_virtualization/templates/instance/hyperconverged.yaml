apiVersion: hco.kubevirt.io/v1beta1
kind: HyperConverged
metadata:
  annotations:
    kubevirt.kubevirt.io/jsonpatch: |-
      [
        {
          "op":"add",
          "path":"/spec/configuration/developerConfiguration/featureGates/-",
          "value":"EnableVirtioFsStorageVolumes"
        }
      ]
  name: kubevirt-hyperconverged
  namespace: openshift-cnv
spec:
  # By default, live migration of virtual machines between nodes with differing CPU models is not possible. To allow live-migrating between nodes
  # with different CPUs, you can set the defaultCPUModel to a common model supported by all cluster nodes. Check the cpu-model.node.kubevirt.io
  # labels on the Node object to find out which CPU models are supported by a specific node. Following the modification of the default CPU model,
  # it is necessary to restart the virtual machines in order for them to adapt the new CPU model.
  #defaultCPUModel: Skylake-Server-noTSX-IBRS
  #
  # Migrate the VM on eviction if live migration is possible, or do nothing. Do nothing means that the VM will be restarted on a different node
  # or shut down depending on its runStrategy setting. This prevents VMs that can't be live-migrated from blocking cluster node reboots.
  # See also https://github.com/kubevirt/kubevirt/blob/dd56bf189f1b7cb257af52106a5fd302a8221231/docs/handling-eviction-requests.md
  evictionStrategy: LiveMigrateIfPossible
  featureGates:
    # DecentralizedLiveMigration enables the decentralized live migration (cross-cluster migration) feature.
    # This feature allows live migration of VirtualMachineInstances between different clusters.
    decentralizedLiveMigration: true
    # Enable persistent reservation of a LUN through the SCSI Persistent Reserve commands on Kubevirt.
    # In order to issue privileged SCSI ioctls, the VM requires activation of the persistent reservation flag.
    # Once this feature gate is enabled, then the additional container with the qemu-pr-helper is deployed
    # inside the virt-handler pod.
    # Enabling (or removing) the feature gate causes the redeployment of the virt-handler pod.
    persistentReservation: true
  infra: {}
  liveMigrationConfig:
    # Use post copy mode when memory dirty rates are high to ensure the migration converges.
    # See also:
    # https://docs.redhat.com/en/documentation/openshift_container_platform/4.18/html/virtualization/live-migration#virt-configuring-live-migration-heavy_virt-configuring-live-migration
    # https://kubevirt.io/user-guide/compute/live_migration/#post-copy
    allowPostCopy: true
  resourceRequirements:
    # CPU overcommit ratio (default is 10). Set it to 1 for no CPU overcommit.
    vmiCPUAllocationRatio: 4
  # Apply the scalable tuning parameters recommended for large scale "High Burst" scenarios (i.e. creating many VMs at once or in large batches).
  # The highBurst profile applies tested and safe QPS and burst values for all Virt components.
  # If using default settings, it took several hours to schedule and start 700 VMs on a 40-node bare metal cluster. The performance is expected
  # to improve with the setting of the highBurst policy.
  # See also:
  # OpenShift Virtualization - Tuning & Scaling Guide
  # https://access.redhat.com/articles/6994974
  tuningPolicy: highBurst
  # Block the deletion of the HyperConverged resource if virtual machines still exist on the cluster. Deletion of HyperConverged resource results
  # in a cascading deletion of virtual machines. BlockUninstallIfWorkloadsExist is the safest choice to protect the workloads from accidental
  # data loss, so it's strongly advised. BlockUninstallIfWorkloadsExist is the default uninstall strategy when none is defined.
  uninstallStrategy: BlockUninstallIfWorkloadsExist
  workloads:
    nodePlacement:
      tolerations:
      - effect: NoSchedule
        key: node-role.kubernetes.io/baremetal
  workloadUpdateStrategy:
    workloadUpdateMethods:
    # LiveMigrate workload update method:
    # VMIs that support live migration are migrated during the update process. The VM guest moves into a new pod with the updated components enabled.
    # VMIs that do not support live migration are not disrupted or updated.
    # If a VMI has the LiveMigrate eviction strategy but does not support live migration, it is not updated.
    # Link: https://docs.redhat.com/en/documentation/openshift_container_platform/4.18/html/virtualization/updating#virt-about-workload-updates_upgrading-virt
    - LiveMigrate
